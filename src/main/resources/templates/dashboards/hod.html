<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>HOD Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin: 20px 0;
        }

        .dashboard-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .card-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #006400;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.8em;
            min-width: 20px;
            text-align: center;
        }

        .action-button {
            background: #006400;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 2px;
        }

        .action-button:hover {
            background: #004d00;
        }

        .recent-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .status-approved { color: #28a745; }
        .status-rejected { color: #dc3545; }
        .status-pending { color: #ffc107; }

        .stats-number {
            font-size: 2em;
            font-weight: bold;
            color: #006400;
            display: block;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <h1>HOD Dashboard - <span th:text="${departmentName}">Department</span></h1>
    <p>Welcome, <span sec:authentication="name"></span>!</p>

    <div class="dashboard-grid">
        <!-- Pending Reviews (User Requests) -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>PENDING REVIEWS (User Requests)</span>
                <span class="notification-badge" th:if="${pendingRequestCount > 0}"
                      th:text="${pendingRequestCount}">3</span>
            </div>
            <div class="card-body">
                <div th:if="${pendingRequestCount > 0}">
                    <div th:each="request : ${pendingRequests}" class="recent-item">
                        <strong th:text="${request.item}">Item</strong>
                        <span th:text="'(Qty: ' + ${request.quantity} + ')'"></span>
                        <br/>
                        <small>From: <span th:text="${request.user.username}">user</span></small>
                        <small th:text="'Priority: ' + ${request.priority}">Priority</small>
                    </div>
                </div>
                <div th:if="${pendingRequestCount == 0}">
                    <p>No pending requests</p>
                </div>
                <a href="/requests" class="action-button">View All</a>
            </div>
        </div>

        <!-- My Requisitions (HOD Created) -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>MY REQUESTS</span>
                <span class="notification-badge" th:if="${myRequestCount > 0}"
                      th:text="${myRequestCount}">5</span>
            </div>
            <div class="card-body">
                <div th:if="${myRequestCount > 0}">
                    <div th:each="request : ${myRequests}" class="recent-item">
                        <strong th:text="${request.item}">Item</strong>
                        <br/>
                        <small class="status-approved"
                               th:if="${request.status.name() == 'APPROVED_BY_HOD'}"
                               th:text="${request.status}">Status</small>
                        <small class="status-rejected"
                               th:if="${request.status.name() == 'REJECTED_BY_HOD'}"
                               th:text="${request.status}">Status</small>
                        <small class="status-pending"
                               th:if="${request.status.name() == 'PENDING_HOD_REVIEW'}"
                               th:text="${request.status}">Status</small>
                    </div>
                </div>
                <div th:if="${myRequestCount == 0}">
                    <p>No personal requests</p>
                </div>
                <a href="/requests?filter=mine" class="action-button">View All</a>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>QUICK ACTIONS</span>
            </div>
            <div class="card-body">
                <a href="/requests/new" class="action-button">New Request</a>
                <a href="/requests/new-walk-in" class="action-button">Walk-in Request</a>
                <form th:action="@{/requests/consolidate}" method="post" style="display: inline;">
                    <button type="submit" class="action-button">Consolidate Approved</button>
                </form>
            </div>
        </div>

        <!-- Approved/Waiting (For PO Module) -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>APPROVED/WAITING (For Budget Approval)</span>
                <span class="notification-badge" th:if="${approvedRequestCount > 0}"
                      th:text="${approvedRequestCount}">12</span>
            </div>
            <div class="card-body">
                <div th:if="${approvedRequestCount > 0}">
                    <div th:each="request : ${approvedRequests}" class="recent-item">
                        <strong th:text="${request.item}">Item</strong>
                        <br/>
                        <small>Est. Cost: $<span th:text="${request.estimatedCost}">0.00</span></small>
                    </div>
                </div>
                <div th:if="${approvedRequestCount == 0}">
                    <p>No approved requests pending budget approval</p>
                </div>
                <a href="/requests?filter=approved" class="action-button">Review</a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>RECENT ACTIVITY</span>
            </div>
            <div class="card-body">
                <div th:if="${recentActivity != null and #lists.size(recentActivity) > 0}">
                    <div th:each="activity : ${recentActivity}" class="recent-item">
                        <span th:text="${activity.item}">Activity</span>
                        <br/>
                        <small th:text="${#temporals.format(activity.updatedAt, 'MMM dd, HH:mm')}">Time</small>
                        <small class="status-approved"
                               th:if="${activity.status.name() == 'APPROVED_BY_HOD'}"
                               th:text="'- ' + ${activity.status}">Status</small>
                        <small class="status-rejected"
                               th:if="${activity.status.name() == 'REJECTED_BY_HOD'}"
                               th:text="'- ' + ${activity.status}">Status</small>
                    </div>
                </div>
                <div th:if="${recentActivity == null or #lists.size(recentActivity) == 0}">
                    <p>No recent activity</p>
                </div>
                <a href="/requests?filter=recent" class="action-button">Activity Log</a>
            </div>
        </div>

        <!-- Department Stats -->
        <div class="dashboard-card">
            <div class="card-header">
                <span>DEPARTMENT STATS</span>
            </div>
            <div class="card-body">
                <p>Total Requests: <span class="stats-number" th:text="${totalDepartmentRequests}">25</span></p>
                <p>Pending Reviews: <span th:text="${pendingRequestCount}">3</span></p>
                <p>Approved Waiting: <span th:text="${approvedRequestCount}">12</span></p>
                <a href="/reports/department" class="action-button">Budget Status</a>
            </div>
        </div>
    </div>

    <!-- Feedback Section -->
    <div class="dashboard-card" th:if="${recentFeedback != null and #lists.size(recentFeedback) > 0}"
         style="margin-top: 20px;">
        <div class="card-header">
            <span>RECENT BUDGET APPROVAL FEEDBACK</span>
        </div>
        <div class="card-body">
            <div th:each="feedback : ${recentFeedback}" class="recent-item">
                <strong th:text="${feedback.consolidatedItem}">Item</strong>
                <span th:text="'($' + ${feedback.totalEstimatedCost} + ')'"></span>
                <br/>
                <small class="status-approved"
                       th:if="${feedback.status.name() == 'APPROVED_BY_BUDGET'}"
                       th:text="'✓ APPROVED by budget approver'">Approved</small>
                <small class="status-rejected"
                       th:if="${feedback.status.name() == 'REJECTED_BY_BUDGET'}"
                       th:text="'✗ REJECTED: ' + ${feedback.reasonForRejection}">Rejected</small>
                <br/>
                <small th:text="'Approved at: ' + ${#temporals.format(feedback.budgetApprovedAt, 'MMM dd, yyyy HH:mm')}">Time</small>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>